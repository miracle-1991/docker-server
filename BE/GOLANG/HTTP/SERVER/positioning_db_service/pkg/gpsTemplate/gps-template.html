<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html x mlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta charset="utf-8"/>
    <title>Google地图轨迹回放测试</title>
    <style type="text/css">
        body,
        html,
        #mapContainer {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            z-index: 1;
        }
    </style>
    <script src="http://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyAY-HsXXPsBUqsbQLDFO8kpNWLANwH0E7k&sensor=false&libraries=drawing,places"></script>
    <script language="javascript">
        function initialize() {
            const str= document.getElementById('gpspings').innerText
            const pointArray = str.split(" ").map((item) => {
                 const [lat, lng] = item.split(",")
                 console.log(lat+", "+lng)
                 return new google.maps.LatLng(lat, lng);
              })

            const timeStr = document.getElementById('gpsTimes').innerText
            const gpsWhenRmQStr = document.getElementById('gpsWhenQueueRm').innerText
            const gpsWhenAddQStr = document.getElementById('gpsWhenQueueAdd').innerText
            const timeArray = timeStr.split("#")
            const rawGpsArray = str.split(" ")
            const gpsWhenRmQArray = gpsWhenRmQStr.split(" ")
            const gpsWhenAddQArray = gpsWhenAddQStr.split(" ")
            const mapOptions = {
                center: pointArray[0],
                zoom: 18,
                panControl: true,
                zoomControl: true,
                mapTypeControl: true,
                scaleControl: true,
                overviewMapControl: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            const map = new google.maps.Map(document.getElementById('mapContainer'), mapOptions);

            const lineSymbol = {
                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                //scale: 2, 
                strokeColor: '#393'
            };

            const line = new google.maps.Polyline({
                path: pointArray,
                icons: [{
                    icon: lineSymbol,
                    offset: '0%'
                }],
                map: map,
            });

            const queRmIcon = {
                url: "https://maps.gstatic.com/intl/en_us/mapfiles/markers2/measle.png",
                size: new google.maps.Size(14, 14),
                anchor: new google.maps.Point(4, 4)
            }

            const queAddIcon = {
                url: "http://maps.gstatic.com/mapfiles/markers2/dd-via.png",
                size: new google.maps.Size(14, 14),
                anchor: new google.maps.Point(4, 4)
            }

            const commonIcon = {
                url: "https://maps.gstatic.com/intl/en_us/mapfiles/markers2/measle_blue.png",
                size: new google.maps.Size(7, 7),
                anchor: new google.maps.Point(4, 4)
            }

            for (let i = 0; i < pointArray.length; i++) {
                tmpIcon = commonIcon
                let infowindow = null
                if (gpsWhenRmQArray.includes(rawGpsArray[i])) {
                    tmpIcon = queRmIcon;
                    infowindow = new google.maps.InfoWindow({
                        content: `Remove at ` + timeArray[i]
                    });
                }else if (gpsWhenAddQArray.includes(rawGpsArray[i])) {
                    tmpIcon = queAddIcon;
                    infowindow = new google.maps.InfoWindow({
                        content: `Rejoin at ` + timeArray[i]
                    });
                }
                var marker = new google.maps.Marker({
                    icon: tmpIcon,
                    position: line.getPath().getAt(i),
                    title: line.getPath().getAt(i).toUrlValue(6) + " | " + timeArray[i],
                    map: map
                });
                if (infowindow != null) {
                    infowindow.open(map, marker);
                }
            }

            function animateCircle() {
                var count = 0;
                var animate1 = window.setInterval(function () {
                    count = (count + 1) % 200;
                    var icons = line.get('icons');
                    icons[0].offset = (count / 2) + '%';
                    line.set('icons', icons);
                }, 100);
            }

            animateCircle();
        }

        google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>
<body>
<div id="mapContainer"></div>
<div id="gpspings" hidden>{{ .GpsPings }}</div>
<div id="gpsTimes" hidden>{{ .GpsTimes }}</div>
<div id="gpsWhenQueueRm" hidden>{{ .GpsWhenQueueRm }}</div>
<div id="gpsWhenQueueAdd" hiden>{{ .GpsWhenQueueAdd }}</div>
</body>
</html>